# Stage 1 - the build process
FROM node:alpine as builder
LABEL stage=builder

RUN mkdir -p /usr/src/builder

WORKDIR /usr/src/builder

ARG PORT
ARG CLIENT_URL
ARG COOKIE_PROTOCOL
ARG COOKIE_DOMAIN
ARG BASE_URL
ARG MONGO_URL
ARG JWT_SECRET
ARG SESSION_SECRET
ARG FACEBOOK_CLIENT_ID
ARG FACEBOOK_CLIENT_SECRET
ARG FACEBOOK_CALLBACK_URL
ARG LINE_LOGIN_CHANNEL_ID
ARG LINE_LOGIN_CHANNEL_SECRET
ARG LINE_LOGIN_CALLBACK_URL
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG GOOGLE_CALLBACK_URL


ENV PORT=${PORT}
ENV CLIENT_URL=${CLIENT_URL}
ENV COOKIE_PROTOCOL=${COOKIE_PROTOCOL}
ENV COOKIE_DOMAIN=${COOKIE_DOMAIN}
ENV BASE_URL=${BASE_URL}
ENV MONGO_URL=${MONGO_URL}
ENV JWT_SECRET=${JWT_SECRET}
ENV SESSION_SECRET=${SESSION_SECRET}
ENV FACEBOOK_CLIENT_ID=${FACEBOOK_CLIENT_ID}
ENV FACEBOOK_CLIENT_SECRET=${FACEBOOK_CLIENT_SECRET}
ENV FACEBOOK_CALLBACK_URL=${FACEBOOK_CALLBACK_URL}
ENV LINE_LOGIN_CHANNEL_ID=${LINE_LOGIN_CHANNEL_ID}
ENV LINE_LOGIN_CHANNEL_SECRET=${LINE_LOGIN_CHANNEL_SECRET}
ENV LINE_LOGIN_CALLBACK_URL=${LINE_LOGIN_CALLBACK_URL}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}

COPY . .

RUN yarn install
RUN yarn run build


# Stage 2 - the production environment
FROM keymetrics/pm2:latest-alpine
LABEL author="Godkoz Money Book"

RUN mkdir -p /usr/src/app

WORKDIR /usr/src/app

COPY --from=builder /usr/src/builder/build /usr/src/app

CMD ["pm2-runtime", "start", "bundle.js"]
